services:
  expressjs:
    build:
      context: ./expressjs
      dockerfile: Dockerfile
    container_name: seery-backend
    ports:
      - "3016:3016"
    env_file:
      - ./expressjs/.env
    environment:
      - PORT=3016
      - NETWORK=${NETWORK:-testnet}
      - BNB_TESTNET_RPC=${BNB_TESTNET_RPC}
    volumes:
      - ./expressjs:/app
      - /app/node_modules
    command: npm start
    restart: unless-stopped

  nextjs:
    build:
      context: ./nextjs
      dockerfile: Dockerfile
      target: deps
    container_name: seery-frontend
    ports:
      - "3015:3015"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3016
      - PORT=3015
      - NODE_ENV=development
    volumes:
      - ./nextjs:/app
      - /app/node_modules
      - /app/.next
    command: sh -c "npm install && npm run dev"
    restart: unless-stopped
    depends_on:
      - expressjs

  bnb:
    build:
      context: ./bnb
      dockerfile: Dockerfile
    ports:
      - "8545:8545"  # Hardhat node default port
    environment:
      - PRIVATE_KEY=${PRIVATE_KEY}
      - BNB_TESTNET_RPC=${BNB_TESTNET_RPC}
      - BNB_MAINNET_RPC=${BNB_MAINNET_RPC}
    volumes:
      - ./bnb:/app
      - /app/node_modules
      - /app/artifacts
      - /app/cache
    command: npx hardhat node --hostname 0.0.0.0
    profiles:
      - tools  # Only start when explicitly requested

  blockscout:
    image: blockscout/blockscout:latest
    ports:
      - "4000:4000"  # Blockscout web interface
    environment:
      - ETHEREUM_JSONRPC_HTTP_URL=http://bnb:8545
      - ETHEREUM_JSONRPC_WS_URL=ws://bnb:8545
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/blockscout
      - SECRET_KEY_BASE=changeme_in_production_use_openssl_rand_hex_64
      - ECTO_USE_SSL=false
      - COIN=BNB
      - NETWORK=Local
      - SUBNETWORK=Hardhat
      - NETWORK_ICON=/images/blockscout_logo.svg
      - DISABLE_EXCHANGE_RATES=true
      - DISABLE_INDEXER=true
    depends_on:
      - postgres
      - bnb
    profiles:
      - tools

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=blockscout
    volumes:
      - postgres_data:/var/lib/postgresql/data
    profiles:
      - tools

volumes:
  postgres_data:
