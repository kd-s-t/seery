name: Auto-Resolve Stakes

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  resolve:
    runs-on: ubuntu-latest
    steps:
      - name: Call Auto-Resolve Endpoint
        id: resolve
        run: |
          API_URL="https://seery-expressjs.vercel.app/api/staking/auto-resolve"
          
          echo "Calling auto-resolve endpoint: $API_URL"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-AutoResolve/1.0")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "$body" | jq '.'
            
            resolved=$(echo "$body" | jq -r '.resolved // 0')
            failed=$(echo "$body" | jq -r '.failed // 0')
            total=$(echo "$body" | jq -r '.total // 0')
            message=$(echo "$body" | jq -r '.message // "N/A"')
            
            echo ""
            echo "=========================================="
            echo "ðŸ“Š AUTO-RESOLVE SUMMARY"
            echo "=========================================="
            echo "âœ… Resolved: $resolved"
            echo "âŒ Failed: $failed"
            echo "ðŸ“‹ Total Expired: $total"
            echo "ðŸ’¬ Message: $message"
            echo "=========================================="
            
            if [ "$total" -gt 0 ]; then
              echo ""
              echo "ðŸ“ Detailed Results:"
              echo "$body" | jq -r '.results[]? | "  Stake \(.stakeId) (\(.cryptoId)): \(.status) - \(.error // .price // "")"'
            fi
            
            echo "::set-output name=resolved::$resolved"
            echo "::set-output name=failed::$failed"
            echo "::set-output name=total::$total"
            
            exit 0
          else
            echo "âŒ Auto-resolve failed with status $http_code"
            echo "Response: $body"
            exit 1
          fi
      
      - name: Summary
        run: |
          echo "### Auto-Resolve Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Resolved | ${{ steps.resolve.outputs.resolved }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | ${{ steps.resolve.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ Total Expired | ${{ steps.resolve.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
